agents:
  queue: "juliaecosystem"
  sandbox.jl: "true"
  os: "linux"
steps:
  - label: "Build and test"
    plugins:
      - JuliaCI/julia#v1:
          # Drop default "registries" directory, so it is not persisted from execution to execution
          persist_depot_dirs: packages,artifacts,compiled
          version: '1.6'
      - staticfloat/sandbox#v1:
          rootfs_url: https://github.com/JuliaCI/rootfs-images/releases/download/v4.16/rr.x86_64.tar.gz
          rootfs_treehash: "add05412f938d36107ffba501572e99823ab3fb0"
          # workspaces:
          #   - "/cache/repos:/cache/repos"
    timeout_in_minutes: 30
    notify:
      - github_commit_status:
          context: "CI"
    commands: |
      echo "--- Print kernel information"
      uname -a
      echo "--- Generate build environment"
      rm -rf obj
      mkdir obj
      cd obj
      cmake ..
      echo "--- Build"
      make --output-sync -j8
      echo "--- Test"
      mkdir -p Testing/Temporary
      mv ../.buildkite/CTestCostData.txt Testing/Temporary
      ctest --output-on-failure -j8
